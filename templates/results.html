{% extends "base.html" %}
{% block title %}×ª×•×¦××•×ª ×•×”×¡×‘×¨×™×{% endblock %}

{% block content %}
<div class="container">

  <h2 class="page-title">×ª×•×¦××•×ª ×©×”×•×–× ×•</h2>
  <p class="meta-line">
    ×’×™×œ: <strong>{{ age }}</strong> |
    ××’×“×¨:
    <strong>{% if gender == 'male' %}×–×›×¨{% elif gender == 'female' %}× ×§×‘×”{% else %}â€”{% endif %}</strong>
  </p>

  {% if severe_flag %}
    <div class="alert alert-warn">
      <strong>×©×™××• ×œ×‘:</strong> ×—×œ×§ ××”×¢×¨×›×™× ×—×¨×™×’×™× ×‘×¦×•×¨×” ×©×™×›×•×œ×” ×œ×“×¨×•×© ×‘×“×™×§×” ×¨×¤×•××™×ª.
      ××•××œ×¥ <strong>×œ×ª×× ×‘×”×§×“×</strong> ×¢× ×¨×•×¤× ×”××©×¤×—×”.
    </div>
  {% endif %}

  {% if rows %}
  <div class="results-toolbar">
    <button type="button" class="btn btn-primary btn-sm" onclick="window.print()">
     ğŸ–¨ï¸ ×”×“×¤×¡ / ×©××•×¨ ×›-PDF
    </button>
<a href="{% url 'reference_ranges' %}" class="btn btn-sm" target="_blank" rel="noopener">×˜×•×•×—×™ ×™×™×—×•×¡</a>

    <button type="button" id="toggle-abnormal" class="btn btn-sm">
      ×”×¦×’ ×¨×§ ×—×¨×™×’×™×
    </button>

    <div class="legend">
      <span class="legend-item"><span class="badge badge-high">×’×‘×•×”</span> ×’×‘×•×”</span>
      <span class="legend-item"><span class="badge badge-low">× ××•×š</span> × ××•×š</span>
      <span class="legend-item"><span class="badge badge-ok">×ª×§×™×Ÿ</span> ×ª×§×™×Ÿ</span>
    </div>
  </div>

  <div class="card">
    <div class="card-body">
      <div class="table-wrap">
        <table class="tbl">
          <thead>
            <tr>
              <th>×¨×›×™×‘</th>
              <th>×”×¢×¨×š ×©×œ×š</th>
              <th>×˜×•×•×— ×™×™×—×•×¡</th>
              <th>×¡×˜×˜×•×¡</th>
              <th style="width:160px;">×¤×¢×•×œ×”</th>
            </tr>
          </thead>
          <tbody>
            {% for r in rows %}
              <tr class="{% if r.status != 'normal' %}row-abnormal{% else %}row-normal{% endif %}">
                <td>{{ r.label }}</td>
                <td>
                  {% if r.status != 'normal' %}
                    <span class="value-flag" data-tip="××—×•×¥ ×œ×˜×•×•×—">{{ r.value }}</span>
                  {% else %}
                    {{ r.value }}
                  {% endif %}
                </td>
                <td>
                  {% if r.range %}
                    <span class="range-tip" data-tip="×˜×•×•×— ×™×™×—×•×¡ ×œ××‘×•×’×¨×™×{% if gender == 'male' %} (×–×›×¨){% elif gender == 'female' %} (× ×§×‘×”){% endif %}">
                      {{ r.range.0 }} â€“ {{ r.range.1 }}
                    </span>
                  {% else %}â€”{% endif %}
                </td>
                <td>
                  {% if r.status == 'low' %}
                    <span class="badge badge-low">× ××•×š</span>
                  {% elif r.status == 'high' %}
                    <span class="badge badge-high">×’×‘×•×”</span>
                  {% else %}
                    <span class="badge badge-ok">×ª×§×™×Ÿ</span>
                  {% endif %}
                </td>
                <td>
                  {% if r.status != 'normal' %}
                    <button type="button" class="btn btn-primary advice-btn" data-target="advice-{{ r.key }}">
                      ××” ××¤×©×¨ ×œ×¢×©×•×ª?
                    </button>
                    <div id="advice-{{ r.key }}" class="advice-panel">
                      <em>{{ r.advice }}</em>
                    </div>
                  {% else %}
                    <span class="muted">â€”</span>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      {% if abnormal_count == 0 %}
        <div class="alert alert-ok">
          ×›×œ ×”×›×‘×•×“! ×”×¢×¨×›×™× ×©××¡×¨×ª ×ª×§×™× ×™× ×•×©××¨×ª ×¢×œ ×’×•×¤×š.
        </div>
      {% endif %}
    </div>
  </div>
  {% else %}
    <p class="muted">×œ× × ××¦××• ×¢×¨×›×™× ×œ×”×¦×’×”.</p>
  {% endif %}

  <div class="nav-actions">
    <a href="/inputs" class="link-back">â†© ×—×–×¨×” ×œ×”×–× ×”</a>
  </div>

  <p class="footnote">
    *××™×“×¢ ×–×” ××™× ×• ×ª×—×œ×™×£ ×œ×™×™×¢×•×¥ ×¨×¤×•××™. ×˜×•×•×—×™ ×”×™×™×—×•×¡ ×¢×©×•×™×™× ×œ×”×©×ª× ×•×ª ×‘×™×Ÿ ××¢×‘×“×•×ª; ×™×© ×œ×¤× ×•×ª ×œ×¨×•×¤× ×œ×‘×™×¨×•×¨ ×¤×¨×˜× ×™.
  </p>
</div>

<script>
  document.querySelectorAll('.advice-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const id = btn.getAttribute('data-target');
      const panel = document.getElementById(id);
      if (!panel) return;
      panel.classList.toggle('open');
      btn.textContent = panel.classList.contains('open') ? '×¡×’×•×¨ ×”×¦×¢×•×ª' : '××” ××¤×©×¨ ×œ×¢×©×•×ª?';
    });
  });

  (function(){
    const btn = document.getElementById('toggle-abnormal');
    if (!btn) return;
    let onlyAbnormal = false;
    btn.addEventListener('click', () => {
      onlyAbnormal = !onlyAbnormal;
      btn.textContent = onlyAbnormal ? '×”×¦×’ ×”×›×œ' : '×”×¦×’ ×¨×§ ×—×¨×™×’×™×';
      document.querySelectorAll('table.tbl tbody tr').forEach(tr => {
        const isAbnormal = tr.classList.contains('row-abnormal');
        tr.style.display = (onlyAbnormal && !isAbnormal) ? 'none' : '';
      });
    });
  })();
</script>
{% endblock %}
