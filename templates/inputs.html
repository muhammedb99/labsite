{% extends "base.html" %}
{% load static %}
{% block title %}הזנת רכיבי בדיקה{% endblock %}

{% block content %}
<div class="container inputs-layout">

  <!-- Sidebar -->
  <aside class="inputs-aside">
    <div class="aside-card">
      <h3 class="aside-title">קטגוריות</h3>
      <nav class="aside-nav" aria-label="קטגוריות בדיקות">
        <a href="#sec-hematology">הימטולוגיה (Diff)</a>
        <a href="#sec-biochem">ביוכימיה</a>
        <a href="#sec-hormones">אנדוקרינולוגיה </a>
      </nav>

      <div class="aside-meta" style="margin-top:.8rem;">
        מולאו: <span id="filled-count">0</span> שדות
        <div><a class="link-small" href="/start">← שינוי גיל/‏Gender</a></div>
      </div>
    </div>
  </aside>

  <!-- Main -->
  <section class="inputs-main">
    <header class="inputs-header">
      <h2 class="page-title">הזנת רכיבי בדיקה</h2>
      <p class="meta-line">גיל: <strong>{{ age }}</strong> | Gender:
        <strong>{{ gender_label|default:gender }}</strong></p>
      {% if form.non_field_errors %}
        <div class="form-error" style="margin-top:.4rem;">{{ form.non_field_errors }}</div>
      {% endif %}
    </header>

    <form method="post" id="lab-form" novalidate>
      {% csrf_token %}

      <!-- ===================== Hematology (Diff) ===================== -->
      <div class="card form-section" id="sec-hematology">
        <div class="card-body">
          <h3 class="section-title">הימטולוגיה (Diff)</h3>

          <div class="grid-3">
            <div class="fi"><div class="lbl">{{ form.NEUTROPHILS_PCT.label }}</div>{{ form.NEUTROPHILS_PCT }}</div>

            <div class="fi"><div class="lbl">{{ form.LYMPHOCYTES_PCT.label }}</div>{{ form.LYMPHOCYTES_PCT }}</div>
            <div class="fi"><div class="lbl">{{ form.LYMPHOCYTES_ABS.label }}</div>{{ form.LYMPHOCYTES_ABS }}</div>

            <div class="fi"><div class="lbl">{{ form.MONOCYTES_PCT.label }}</div>{{ form.MONOCYTES_PCT }}</div>
            <div class="fi"><div class="lbl">{{ form.MONOCYTES_ABS.label }}</div>{{ form.MONOCYTES_ABS }}</div>

            <div class="fi"><div class="lbl">{{ form.EOSINOPHILS_PCT.label }}</div>{{ form.EOSINOPHILS_PCT }}</div>
            <div class="fi"><div class="lbl">{{ form.EOSINOPHILS_ABS.label }}</div>{{ form.EOSINOPHILS_ABS }}</div>

            <div class="fi"><div class="lbl">{{ form.BASOPHILS_PCT.label }}</div>{{ form.BASOPHILS_PCT }}</div>
            <div class="fi"><div class="lbl">{{ form.BASOPHILS_ABS.label }}</div>{{ form.BASOPHILS_ABS }}</div>

            {% if form.MPV %}<div class="fi"><div class="lbl">{{ form.MPV.label }}</div>{{ form.MPV }}</div>{% endif %}
            {% if form.LUC_PCT %}<div class="fi"><div class="lbl">{{ form.LUC_PCT.label }}</div>{{ form.LUC_PCT }}</div>{% endif %}
            {% if form.LUC_ABS %}<div class="fi"><div class="lbl">{{ form.LUC_ABS.label }}</div>{{ form.LUC_ABS }}</div>{% endif %}
          </div>
        </div>
      </div>

      <!-- ===================== Biochemistry ===================== -->
      <div class="card form-section" id="sec-biochem">
        <div class="card-body">
          <h3 class="section-title">ביוכימיה</h3>

          <div class="grid-3">
            <div class="fi"><div class="lbl">{{ form.GLUCOSE_FASTING.label }}</div>{{ form.GLUCOSE_FASTING }}</div>
            <div class="fi"><div class="lbl">{{ form.UREA.label }}</div>{{ form.UREA }}</div>
            <div class="fi"><div class="lbl">{{ form.CREATININE.label }}</div>{{ form.CREATININE }}</div>

            <div class="fi"><div class="lbl">{{ form.TRIGLYCERIDES.label }}</div>{{ form.TRIGLYCERIDES }}</div>
            <div class="fi"><div class="lbl">{{ form.AST.label }}</div>{{ form.AST }}</div>
            <div class="fi"><div class="lbl">{{ form.ALT.label }}</div>{{ form.ALT }}</div>

            <div class="fi"><div class="lbl">{{ form.ALK_PHOSPHATASE.label }}</div>{{ form.ALK_PHOSPHATASE }}</div>
            {% if form.LDH %}<div class="fi"><div class="lbl">{{ form.LDH.label }}</div>{{ form.LDH }}</div>{% endif %}
            <div class="fi"><div class="lbl">{{ form.URIC_ACID.label }}</div>{{ form.URIC_ACID }}</div>

            <div class="fi"><div class="lbl">{{ form.SODIUM.label }}</div>{{ form.SODIUM }}</div>
            <div class="fi"><div class="lbl">{{ form.POTASSIUM.label }}</div>{{ form.POTASSIUM }}</div>
            <div class="fi"><div class="lbl">{{ form.CALCIUM.label }}</div>{{ form.CALCIUM }}</div>

            <div class="fi"><div class="lbl">{{ form.PROTEIN_TOTAL.label }}</div>{{ form.PROTEIN_TOTAL }}</div>
            <div class="fi"><div class="lbl">{{ form.ALBUMIN.label }}</div>{{ form.ALBUMIN }}</div>

            <div class="fi"><div class="lbl">{{ form.CHOLESTEROL_TOTAL.label }}</div>{{ form.CHOLESTEROL_TOTAL }}</div>
            <div class="fi"><div class="lbl">{{ form.CHOLESTEROL_HDL.label }}</div>{{ form.CHOLESTEROL_HDL }}</div>
            <div class="fi"><div class="lbl">{{ form.CHOLESTEROL_LDL_CALC.label }}</div>{{ form.CHOLESTEROL_LDL_CALC }}</div>
            <div class="fi"><div class="lbl">{{ form.NON_HDL_CHOLESTEROL.label }}</div>{{ form.NON_HDL_CHOLESTEROL }}</div>

            <div class="fi"><div class="lbl">{{ form.BILIRUBIN_TOTAL.label }}</div>{{ form.BILIRUBIN_TOTAL }}</div>
            <div class="fi"><div class="lbl">{{ form.BILIRUBIN_DIRECT.label }}</div>{{ form.BILIRUBIN_DIRECT }}</div>

            {% if form.HEMOLYTIC_FLAG %}<div class="fi"><div class="lbl">{{ form.HEMOLYTIC_FLAG.label }}</div>{{ form.HEMOLYTIC_FLAG }}</div>{% endif %}
            {% if form.LIPEMIC_FLAG %}<div class="fi"><div class="lbl">{{ form.LIPEMIC_FLAG.label }}</div>{{ form.LIPEMIC_FLAG }}</div>{% endif %}
            {% if form.ICTERIC_FLAG %}<div class="fi"><div class="lbl">{{ form.ICTERIC_FLAG.label }}</div>{{ form.ICTERIC_FLAG }}</div>{% endif %}
          </div>
        </div>
      </div>

      <!-- ===================== Hormones / Endocrinology (includes proteins/thyroid/iron/vitamins) ===================== -->
      <div class="card form-section" id="sec-hormones">
        <div class="card-body">
          <h3 class="section-title">אנדוקרינולוגיה </h3>

          <div class="grid-3">
            {% if form.LH %}<div class="fi"><div class="lbl">{{ form.LH.label }}</div>{{ form.LH }}</div>{% endif %}
            {% if form.FSH %}<div class="fi"><div class="lbl">{{ form.FSH.label }}</div>{{ form.FSH }}</div>{% endif %}
            {% if form.PROLACTIN %}<div class="fi"><div class="lbl">{{ form.PROLACTIN.label }}</div>{{ form.PROLACTIN }}</div>{% endif %}

            {% if form.PROGESTERONE %}<div class="fi"><div class="lbl">{{ form.PROGESTERONE.label }}</div>{{ form.PROGESTERONE }}</div>{% endif %}
            {% if form.TESTOSTERONE_TOTAL %}<div class="fi"><div class="lbl">{{ form.TESTOSTERONE_TOTAL.label }}</div>{{ form.TESTOSTERONE_TOTAL }}</div>{% endif %}

            <div class="fi"><div class="lbl">{{ form.TSH.label }}</div>{{ form.TSH }}</div>
            {% if form.T4_FREE %}<div class="fi"><div class="lbl">{{ form.T4_FREE.label }}</div>{{ form.T4_FREE }}</div>{% endif %}
            {% if form.T3_FREE %}<div class="fi"><div class="lbl">{{ form.T3_FREE.label }}</div>{{ form.T3_FREE }}</div>{% endif %}

            <div class="fi"><div class="lbl">{{ form.VITAMIN_B12.label }}</div>{{ form.VITAMIN_B12 }}</div>
            {% if form.IRON %}<div class="fi"><div class="lbl">{{ form.IRON.label }}</div>{{ form.IRON }}</div>{% endif %}
            <div class="fi"><div class="lbl">{{ form.FERRITIN.label }}</div>{{ form.FERRITIN }}</div>
          </div>
        </div>
      </div>

      <div class="form-actions sticky-actions">
        <button type="submit" id="continue-btn" class="btn btn-primary btn-lg" disabled>המשך</button>
        <span class="muted small-note">צריך למלא לפחות רכיב אחד כדי להמשיך</span>
      </div>
    </form>
  </section>
</div>

<script>
  (function(){
    const form = document.getElementById('lab-form');
    const btn = document.getElementById('continue-btn');
    const counter = document.getElementById('filled-count');

    const countFilled = () =>
      Array.from(form.querySelectorAll('input[type="number"],input[type="text"]'))
           .filter(i => i.value && i.value.trim() !== '').length;

    function updateState(){
      const n = countFilled();
      if (counter) counter.textContent = n;
      btn.disabled = n === 0;
    }
    form.addEventListener('input', updateState);
    document.addEventListener('DOMContentLoaded', updateState);
  })();

  document.querySelectorAll('.aside-nav a').forEach(a => {
    a.addEventListener('click', e => {
      const id = a.getAttribute('href').slice(1);
      const el = document.getElementById(id);
      if (el){
        e.preventDefault();
        el.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    });
  });
</script>
{% endblock %}
